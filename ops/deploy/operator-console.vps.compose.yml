services:
  operator-console:
    build:
      context: ../..
      dockerfile: apps/operator_console/Dockerfile
    container_name: autwinmill_operator_console
    restart: unless-stopped
    environment:
      OPERATOR_ADMIN_USER: "${OPERATOR_ADMIN_USER:-admin}"
      OPERATOR_ADMIN_PASSWORD: "${OPERATOR_ADMIN_PASSWORD}"
      OPERATOR_JWT_SECRET: "${OPERATOR_JWT_SECRET}"
      OPERATOR_JWT_TTL_MINUTES: "${OPERATOR_JWT_TTL_MINUTES:-480}"
      OPERATOR_ENV: "${OPERATOR_ENV:-production}"
      OPERATOR_DEFAULT_TENANT: "${OPERATOR_DEFAULT_TENANT:-default}"
      OPERATOR_ALLOWED_ORIGINS: "${OPERATOR_ALLOWED_ORIGINS}"
      OPERATOR_ALLOWED_ENDPOINT_HOSTS: "${OPERATOR_ALLOWED_ENDPOINT_HOSTS:-}"
      OPERATOR_TOKEN_TARGET_HOSTS: "${OPERATOR_TOKEN_TARGET_HOSTS:-}"
      OPERATOR_DATA_DIR: "/app/data"
      OPERATOR_DB_URL: "${OPERATOR_DB_URL}"
      WINDMILL_API_TOKEN: "${WINDMILL_API_TOKEN:-}"
    volumes:
      - operator_console_data:/app/data

  operator-edge:
    image: caddy:2.8
    container_name: autwinmill_operator_edge
    restart: unless-stopped
    depends_on:
      - operator-console
    environment:
      OPERATOR_PUBLIC_DOMAIN: "${OPERATOR_PUBLIC_DOMAIN:-}"
    command: >
      /bin/sh -c "
      if [ -z \"${OPERATOR_PUBLIC_DOMAIN}\" ]; then
        echo 'OPERATOR_PUBLIC_DOMAIN is required';
        exit 1;
      fi;
      caddy reverse-proxy --from ${OPERATOR_PUBLIC_DOMAIN} --to operator-console:8088 \
        --header-up \"X-Forwarded-Proto: {http.request.scheme}\" \
        --header-down \"Strict-Transport-Security: max-age=31536000;\" \
        --header-down \"X-Frame-Options: DENY\" \
        --header-down \"X-Content-Type-Options: nosniff\"
      "
    ports:
      - "${EDGE_HTTP_PORT:-80}:80"
      - "${EDGE_HTTPS_PORT:-443}:443"
    volumes:
      - operator_caddy_data:/data
      - operator_caddy_config:/config

volumes:
  operator_console_data:
  operator_caddy_data:
  operator_caddy_config:
