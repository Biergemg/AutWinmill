<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Einstein Kids - Dashboard Cyn con Agente AI</title>
    <meta name="description"
        content="Panel de control avanzado con Agente AI para Einstein Kids. Gesti√≥n inteligente de leads y escalaciones." />
    <meta property="og:title" content="Einstein Kids - AI Dashboard" />
    <meta property="og:description" content="Dashboard potenciado por IA para gesti√≥n de Einstein Kids." />
    <meta property="og:type" content="website" />
    <meta property="og:site_name" content="Einstein Kids AI" />
    <meta property="og:locale" content="es_MX" />
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .dashboard {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            text-align: center;
        }

        .header h1 {
            color: #667eea;
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header .subtitle {
            color: #666;
            font-size: 1.2em;
        }

        .ai-status {
            display: inline-block;
            background: #00b894;
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.9em;
            margin-top: 10px;
        }

        .ai-status.offline {
            background: #d63031;
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .metric-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease;
        }

        .metric-card:hover {
            transform: translateY(-5px);
        }

        .metric-card .title {
            font-size: 1.1em;
            color: #666;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .metric-card .value {
            font-size: 2.5em;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 5px;
        }

        .metric-card .subtitle {
            font-size: 0.9em;
            color: #999;
        }

        .section {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        .section h2 {
            color: #667eea;
            margin-bottom: 20px;
            font-size: 1.8em;
        }

        .ai-conversation {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin: 10px 0;
        }

        .message {
            margin: 10px 0;
            padding: 10px 15px;
            border-radius: 15px;
            max-width: 80%;
        }

        .message.inbound {
            background: #e3f2fd;
            margin-left: auto;
            text-align: right;
        }

        .message.outbound {
            background: #f1f8e9;
            margin-right: auto;
        }

        .message-meta {
            font-size: 0.8em;
            color: #666;
            margin-top: 5px;
        }

        .ai-confidence {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.7em;
            font-weight: bold;
        }

        .confidence-high {
            background: #00b894;
            color: white;
        }

        .confidence-medium {
            background: #fdcb6e;
            color: #333;
        }

        .confidence-low {
            background: #d63031;
            color: white;
        }

        .escalation-banner {
            background: #ffeaa7;
            border: 2px solid #fdcb6e;
            border-radius: 10px;
            padding: 15px;
            margin: 10px 0;
            color: #333;
        }

        .escalation-banner.critical {
            background: #fab1a0;
            border-color: #e17055;
        }

        .table-container {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        th,
        td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        th {
            background: #f8f9fa;
            font-weight: 600;
            color: #667eea;
        }

        .status-badge {
            padding: 4px 8px;
            border-radius: 20px;
            font-size: 0.8em;
            font-weight: 600;
        }

        .status-hot {
            background: #ffeaa7;
            color: #d63031;
        }

        .status-new {
            background: #74b9ff;
            color: white;
        }

        .status-customer {
            background: #00b894;
            color: white;
        }

        .status-claimed {
            background: #fdcb6e;
            color: #e17055;
        }

        .status-ai {
            background: #a29bfe;
            color: white;
        }

        .status-human {
            background: #fd79a8;
            color: white;
        }

        .action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 25px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5a67d8;
            transform: translateY(-2px);
        }

        .btn-success {
            background: #00b894;
            color: white;
        }

        .btn-success:hover {
            background: #00a085;
            transform: translateY(-2px);
        }

        .btn-danger {
            background: #d63031;
            color: white;
        }

        .btn-danger:hover {
            background: #c0392b;
            transform: translateY(-2px);
        }

        .btn-ai {
            background: #a29bfe;
            color: white;
        }

        .btn-ai:hover {
            background: #6c5ce7;
            transform: translateY(-2px);
        }

        .loading {
            text-align: center;
            padding: 50px;
            color: #667eea;
        }

        .error {
            background: #ffe6e6;
            color: #d63031;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }

        .success {
            background: #e6ffe6;
            color: #00b894;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }

        .chart-container {
            height: 300px;
            margin: 20px 0;
            background: #f8f9fa;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #999;
            font-style: italic;
        }

        .refresh-indicator {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #667eea;
            color: white;
            padding: 10px 15px;
            border-radius: 25px;
            font-size: 0.9em;
            z-index: 1000;
        }

        .ai-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .ai-stat {
            background: white;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            border: 1px solid #eee;
        }

        .ai-stat .number {
            font-size: 1.5em;
            font-weight: bold;
            color: #667eea;
        }

        .ai-stat .label {
            font-size: 0.9em;
            color: #666;
            margin-top: 5px;
        }

        @media (max-width: 768px) {
            .metrics-grid {
                grid-template-columns: 1fr;
            }

            .header h1 {
                font-size: 2em;
            }

            .metric-card .value {
                font-size: 2em;
            }

            .action-buttons {
                flex-direction: column;
            }

            .btn {
                width: 100%;
            }
        }
    </style>
</head>

<body>
    <div class="dashboard">
        <!-- Header -->
        <div class="header">
            <h1>üß† Einstein Kids - Dashboard Cyn</h1>
            <p class="subtitle">Panel de Control con Agente AI</p>
            <div class="ai-status" id="aiStatus">
                ü§ñ Agente AI Activo
            </div>
            <div class="refresh-indicator" id="refreshIndicator">
                √öltima actualizaci√≥n: <span id="lastUpdate">--</span>
            </div>
        </div>

        <!-- M√©tricas Principales -->
        <div class="metrics-grid">
            <div class="metric-card">
                <div class="title">Total Leads</div>
                <div class="value" id="totalLeads">--</div>
                <div class="subtitle">Hoy: <span id="leadsToday">--</span></div>
            </div>

            <div class="metric-card">
                <div class="title">Ventas Confirmadas</div>
                <div class="value" id="totalSales">--</div>
                <div class="subtitle">$<span id="totalRevenue">--</span> MXN</div>
            </div>

            <div class="metric-card">
                <div class="title">Tasa de Conversi√≥n</div>
                <div class="value" id="conversionRate">--</div>
                <div class="subtitle">Leads ‚Üí Ventas</div>
            </div>

            <div class="metric-card">
                <div class="title">Agente AI</div>
                <div class="value" id="aiResponseRate">--</div>
                <div class="subtitle"><span id="aiResponses">--</span> respuestas hoy</div>
            </div>
        </div>

        <!-- Estad√≠sticas del Agente AI -->
        <div class="section">
            <h2>ü§ñ Estad√≠sticas del Agente AI</h2>
            <div class="ai-stats">
                <div class="ai-stat">
                    <div class="number" id="aiTotalResponses">--</div>
                    <div class="label">Total Respuestas</div>
                </div>
                <div class="ai-stat">
                    <div class="number" id="aiConfidenceAvg">--</div>
                    <div class="label">Confianza Promedio</div>
                </div>
                <div class="ai-stat">
                    <div class="number" id="aiEscalations">--</div>
                    <div class="label">Escalaciones a Humano</div>
                </div>
                <div class="ai-stat">
                    <div class="number" id="aiSuccessRate">--</div>
                    <div class="label">Tasa de √âxito</div>
                </div>
            </div>

            <div class="action-buttons">
                <button class="btn btn-ai" onclick="trainAI()">üß† Entrenar Agente</button>
                <button class="btn btn-primary" onclick="viewAIResponses()">üìä Ver Respuestas AI</button>
                <button class="btn btn-danger" onclick="pauseAI()">‚è∏Ô∏è Pausar Agente</button>
            </div>
        </div>

        <!-- Conversaciones Recientes con AI -->
        <div class="section">
            <h2>üí¨ Conversaciones Recientes (AI)</h2>
            <div id="recentConversations">
                <div class="loading">Cargando conversaciones...</div>
            </div>
        </div>

        <!-- Leads Calientes -->
        <div class="section">
            <h2>üî• Leads Calientes (Score ‚â• 70)</h2>
            <div id="hotLeadsSection">
                <div class="loading">Cargando leads calientes...</div>
            </div>
        </div>

        <!-- Claims Pendientes -->
        <div class="section">
            <h2>üí∞ Claims de Pago Pendientes</h2>
            <div id="pendingClaimsSection">
                <div class="loading">Cargando claims pendientes...</div>
            </div>
        </div>

        <!-- Escalaciones Recientes -->
        <div class="section">
            <h2>üö® Escalaciones Recientes (Requieren Atenci√≥n Humana)</h2>
            <div id="recentEscalations">
                <div class="loading">Cargando escalaciones...</div>
            </div>
        </div>

        <!-- Acciones R√°pidas -->
        <div class="section">
            <h2>‚ö° Acciones R√°pidas</h2>
            <div class="action-buttons">
                <button class="btn btn-primary" onclick="refreshDashboard()">üîÑ Actualizar Dashboard</button>
                <button class="btn btn-success" onclick="generateAIReport()">üìà Reporte AI</button>
                <button class="btn btn-ai" onclick="viewKnowledgeBase()">üß† Ver Knowledge Base</button>
                <button class="btn btn-danger" onclick="exportAllData()">üì§ Exportar Todo</button>
            </div>
        </div>
    </div>

    <script>
        // Funciones del Dashboard con AI
        let dashboardData = {};
        let aiData = {};

        async function loadDashboard() {
            try {
                showLoading();

                // Cargar datos principales
                const response = await fetch('/api/scripts/einstein_kids/dashboard_cyn/run', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({})
                });

                if (!response.ok) {
                    throw new Error('Error al cargar dashboard');
                }

                const data = await response.json();
                dashboardData = data;

                // Cargar datos del agente AI
                await loadAIData();

                // Actualizar interfaz
                updateMetrics(data);
                updateAIStats(aiData);
                updateRecentConversations(aiData);
                updateHotLeads(data.hot_leads);
                updatePendingClaims(data.claims_pendientes);
                updateRecentEscalations(aiData);

                updateLastUpdate();
                hideLoading();

            } catch (error) {
                showError('Error al cargar dashboard: ' + error.message);
            }
        }

        async function loadAIData() {
            try {
                const response = await fetch('/api/scripts/einstein_kids/ai_agent_stats/run', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        period: 'today'
                    })
                });

                if (!response.ok) {
                    throw new Error('Error al cargar datos AI');
                }

                aiData = await response.json();

            } catch (error) {
                console.error('Error cargando datos AI:', error);
                aiData = {
                    total_responses: 0,
                    avg_confidence: 0,
                    escalations: 0,
                    success_rate: 0
                };
            }
        }

        function updateMetrics(data) {
            // M√©tricas principales
            document.getElementById('totalLeads').textContent = data.resumen_general?.total_leads || '0';
            document.getElementById('leadsToday').textContent = data.daily_report?.leads?.nuevos || '0';

            document.getElementById('totalSales').textContent = data.resumen_general?.ventas_confirmadas || '0';
            document.getElementById('totalRevenue').textContent = (data.resumen_general?.monto_total || 0).toLocaleString();

            document.getElementById('conversionRate').textContent = (data.resumen_general?.conversion_rate || 0) + '%';

            // M√©tricas del agente AI
            document.getElementById('aiResponseRate').textContent = (aiData.success_rate || 0) + '%';
            document.getElementById('aiResponses').textContent = aiData.total_responses || '0';
        }

        function updateAIStats(aiData) {
            document.getElementById('aiTotalResponses').textContent = aiData.total_responses || '0';
            document.getElementById('aiConfidenceAvg').textContent = (aiData.avg_confidence || 0).toFixed(1) + '%';
            document.getElementById('aiEscalations').textContent = aiData.escalations || '0';
            document.getElementById('aiSuccessRate').textContent = (aiData.success_rate || 0) + '%';
        }

        function updateRecentConversations(aiData) {
            const section = document.getElementById('recentConversations');

            if (!aiData.recent_conversations || aiData.recent_conversations.length === 0) {
                section.innerHTML = '<p>No hay conversaciones recientes con el agente AI.</p>';
                return;
            }

            let html = '';
            aiData.recent_conversations.forEach(conv => {
                html += `
                    <div class="ai-conversation">
                        <div class="message inbound">
                            <strong>${conv.lead_name}</strong><br>
                            ${conv.inbound_message}
                            <div class="message-meta">
                                ${conv.timestamp} | Tel: ${conv.phone}
                            </div>
                        </div>
                        <div class="message outbound">
                            <strong>Agente AI</strong>
                            <span class="ai-confidence confidence-${conv.confidence_level}">
                                Confianza: ${conv.confidence}%
                            </span><br>
                            ${conv.ai_response}
                            <div class="message-meta">
                                ${conv.timestamp}
                                ${conv.needs_escalation ? '<span style="color: #d63031;">‚ö†Ô∏è Escalado a humano</span>' : ''}
                            </div>
                        </div>
                    </div>
                `;
            });

            section.innerHTML = html;
        }

        function updateHotLeads(hotLeads) {
            const section = document.getElementById('hotLeadsSection');

            if (!hotLeads || hotLeads.length === 0) {
                section.innerHTML = '<p>No hay leads calientes en este momento.</p>';
                return;
            }

            let html = `
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Nombre</th>
                                <th>Tel√©fono</th>
                                <th>Email</th>
                                <th>Score</th>
                                <th>Etapa</th>
                                <th>Agente</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            hotLeads.forEach(lead => {
                const agentType = lead.last_interaction_agent || 'AI';
                const agentBadge = agentType === 'AI' ?
                    '<span class="status-badge status-ai">AI</span>' :
                    '<span class="status-badge status-human">Humano</span>';

                html += `
                    <tr>
                        <td>${lead.nombre}</td>
                        <td>${lead.telefono}</td>
                        <td>${lead.email}</td>
                        <td><strong>${lead.score}</strong></td>
                        <td><span class="status-badge status-hot">${lead.stage}</span></td>
                        <td>${agentBadge}</td>
                        <td>
                            <button class="btn btn-primary" onclick="contactLead('${lead.id}', '${lead.telefono}')">Contactar</button>
                            <button class="btn btn-ai" onclick="viewAIConversation('${lead.id}')">Ver AI</button>
                        </td>
                    </tr>
                `;
            });

            html += '</tbody></table></div>';
            section.innerHTML = html;
        }

        function updatePendingClaims(claims) {
            const section = document.getElementById('pendingClaimsSection');

            if (!claims || claims.length === 0) {
                section.innerHTML = '<p>No hay claims pendientes.</p>';
                return;
            }

            let html = `
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Nombre</th>
                                <th>Tel√©fono</th>
                                <th>Fecha Claim</th>
                                <th>Prueba</th>
                                <th>Agente</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            claims.forEach(claim => {
                const agentType = claim.ai_processed ? 'AI' : 'Humano';
                const agentBadge = agentType === 'AI' ?
                    '<span class="status-badge status-ai">AI</span>' :
                    '<span class="status-badge status-human">Humano</span>';

                html += `
                    <tr>
                        <td>${claim.nombre}</td>
                        <td>${claim.telefono}</td>
                        <td>${claim.fecha_claim}</td>
                        <td>${claim.proof ? 'Ver prueba' : 'Sin prueba'}</td>
                        <td>${agentBadge}</td>
                        <td>
                            <button class="btn btn-success" onclick="confirmClaim('${claim.claim_id}')">Confirmar</button>
                            <button class="btn btn-danger" onclick="rejectClaim('${claim.claim_id}')">Rechazar</button>
                        </td>
                    </tr>
                `;
            });

            html += '</tbody></table></div>';
            section.innerHTML = html;
        }

        function updateRecentEscalations(escalations) {
            const section = document.getElementById('recentEscalations');

            if (!escalations || escalations.length === 0) {
                section.innerHTML = '<p>No hay escalaciones recientes.</p>';
                return;
            }

            let html = '';
            escalations.forEach(esc => {
                const priorityClass = esc.priority === 'critical' ? 'critical' : '';

                html += `
                    <div class="escalation-banner ${priorityClass}">
                        <h4>üö® Escalaci√≥n ${esc.priority.toUpperCase()}</h4>
                        <p><strong>Lead:</strong> ${esc.lead_name} (${esc.phone})</p>
                        <p><strong>Raz√≥n:</strong> ${esc.reason}</p>
                        <p><strong>Mensaje:</strong> "${esc.message}"</p>
                        <p><strong>Fecha:</strong> ${esc.timestamp}</p>
                        <div class="action-buttons">
                            <button class="btn btn-primary" onclick="respondToEscalation('${esc.id}')">Responder</button>
                            <button class="btn btn-success" onclick="markEscalationResolved('${esc.id}')">Resolver</button>
                        </div>
                    </div>
                `;
            });

            section.innerHTML = html;
        }

        // Funciones de acci√≥n
        function contactLead(leadId, phone) {
            if (confirm(`¬øAbrir WhatsApp para contactar al lead ${phone}?`)) {
                window.open(`https://wa.me/${phone.replace(/\D/g, '')}`, '_blank');
            }
        }

        function viewAIConversation(leadId) {
            alert(`Ver conversaci√≥n AI del lead ${leadId} - Esta funci√≥n se implementar√°`);
        }

        function confirmClaim(claimId) {
            if (confirm('¬øConfirmar este pago?')) {
                // Implementar confirmaci√≥n
                alert('Pago confirmado exitosamente');
                loadDashboard();
            }
        }

        function rejectClaim(claimId) {
            if (confirm('¬øRechazar este pago?')) {
                // Implementar rechazo
                alert('Pago rechazado');
                loadDashboard();
            }
        }

        function respondToEscalation(escalationId) {
            alert(`Responder a escalaci√≥n ${escalationId} - Esta funci√≥n se implementar√°`);
        }

        function markEscalationResolved(escalationId) {
            if (confirm('¬øMarcar esta escalaci√≥n como resuelta?')) {
                alert('Escalaci√≥n marcada como resuelta');
                loadDashboard();
            }
        }

        function trainAI() {
            if (confirm('¬øEntrenar al agente AI con nuevos datos?')) {
                alert('Agente AI entrenado exitosamente - Esta funci√≥n se implementar√°');
            }
        }

        function viewAIResponses() {
            alert('Ver todas las respuestas del agente AI - Esta funci√≥n se implementar√°');
        }

        function pauseAI() {
            if (confirm('¬øPausar al agente AI? Las conversaciones ser√°n manejadas por humanos.')) {
                document.getElementById('aiStatus').textContent = 'ü§ñ Agente AI Pausado';
                document.getElementById('aiStatus').className = 'ai-status offline';
                alert('Agente AI pausado exitosamente');
            }
        }

        function generateAIReport() {
            alert('Generar reporte detallado del agente AI - Esta funci√≥n se implementar√°');
        }

        function viewKnowledgeBase() {
            alert('Ver y editar Knowledge Base - Esta funci√≥n se implementar√°');
        }

        function exportAllData() {
            alert('Exportar todos los datos - Esta funci√≥n se implementar√°');
        }

        function refreshDashboard() {
            loadDashboard();
        }

        function showLoading() {
            document.querySelectorAll('.loading').forEach(el => {
                el.style.display = 'block';
            });
        }

        function hideLoading() {
            document.querySelectorAll('.loading').forEach(el => {
                el.style.display = 'none';
            });
        }

        function showError(message) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error';
            errorDiv.textContent = message;
            document.querySelector('.dashboard').insertBefore(errorDiv, document.querySelector('.metrics-grid'));

            setTimeout(() => {
                errorDiv.remove();
            }, 5000);
        }

        function updateLastUpdate() {
            document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString('es-MX');
        }

        // Auto-refresh cada 30 segundos
        setInterval(loadDashboard, 30000);

        // Cargar dashboard al iniciar
        document.addEventListener('DOMContentLoaded', loadDashboard);
    </script>
</body>

</html>