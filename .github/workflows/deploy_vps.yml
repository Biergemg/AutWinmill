name: deploy-vps

on:
  workflow_dispatch:
    inputs:
      target:
        description: "Target stack"
        required: true
        default: "all"
        type: choice
        options:
          - all
          - cyn
          - operator
  push:
    branches: [main]
    paths:
      - "apps/operator_console/**"
      - "ops/**"
      - "tools/deploy_scripts.js"
      - ".github/workflows/deploy_vps.yml"

jobs:
  preflight:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"
      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install -r apps/operator_console/requirements.txt
          pip install pytest ruff mypy types-requests
      - name: Operator tests
        run: pytest tests/operator_console -q
      - name: Ruff (isolated)
        run: ruff check --isolated apps/operator_console tests/operator_console
      - name: Mypy
        run: mypy apps/operator_console/app --ignore-missing-imports --disable-error-code=misc --disable-error-code=no-any-return --disable-error-code=untyped-decorator --disable-error-code=import-untyped

  deploy:
    needs: preflight
    runs-on: ubuntu-latest
    steps:
      - name: Deploy over SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          script_stop: true
          script: |
            set -euo pipefail
            TARGET="${{ github.event.inputs.target }}"
            if [ -z "${TARGET}" ]; then TARGET="all"; fi

            cd "${{ secrets.VPS_DEPLOY_PATH }}"
            git fetch --all
            git checkout main
            git pull --ff-only
            chmod +x ops/deploy/preflight_vps.sh
            /bin/bash ops/deploy/preflight_vps.sh ops/deploy/.env.cyn.vps ops/deploy/.env.operator-console.vps

            if [ "${TARGET}" = "all" ] || [ "${TARGET}" = "cyn" ]; then
              docker compose --env-file ops/deploy/.env.cyn.vps -f ops/docker-compose-cyn.yml --profile vps up -d --remove-orphans
            fi

            if [ "${TARGET}" = "all" ] || [ "${TARGET}" = "operator" ]; then
              docker compose --env-file ops/deploy/.env.operator-console.vps -f ops/deploy/operator-console.compose.yml up -d --build --remove-orphans
            fi
