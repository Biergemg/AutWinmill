name: deploy-vps

on:
  workflow_dispatch:
    inputs:
      target:
        description: "Target stack"
        required: true
        default: "all"
        type: choice
        options:
          - all
          - cyn
          - operator
  push:
    branches: [main]
    paths:
      - "apps/operator_console/**"
      - "ops/**"
      - "tools/deploy_scripts.js"
      - ".github/workflows/deploy_vps.yml"

jobs:
  preflight:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"
      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install -r apps/operator_console/requirements.txt
          pip install pytest ruff mypy types-requests
      - name: Operator tests
        run: pytest tests/operator_console -q
      - name: Ruff (isolated)
        run: ruff check --isolated apps/operator_console tests/operator_console
      - name: Mypy
        run: mypy apps/operator_console/app --ignore-missing-imports --disable-error-code=misc --disable-error-code=no-any-return --disable-error-code=untyped-decorator --disable-error-code=import-untyped

  deploy:
    needs: preflight
    runs-on: ubuntu-latest
    env:
      VPS_HOST: ${{ secrets.VPS_HOST }}
      VPS_USER: ${{ secrets.VPS_USER }}
      VPS_SSH_KEY: ${{ secrets.VPS_SSH_KEY }}
      VPS_DEPLOY_PATH: ${{ secrets.VPS_DEPLOY_PATH }}
    steps:
      - name: Validate deploy secrets
        id: validate_secrets
        run: |
          missing=()
          for key in VPS_HOST VPS_USER VPS_SSH_KEY VPS_DEPLOY_PATH; do
            if [ -z "${!key:-}" ]; then
              missing+=("$key")
            fi
          done
          if [ "${#missing[@]}" -gt 0 ]; then
            if [ "$GITHUB_EVENT_NAME" = "workflow_dispatch" ]; then
              echo "::error::Missing required repo secrets: ${missing[*]}"
              exit 1
            fi
            echo "::warning::Skipping deploy (missing repo secrets: ${missing[*]})."
            echo "ready=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          echo "ready=true" >> "$GITHUB_OUTPUT"
      - name: Deploy over SSH
        if: steps.validate_secrets.outputs.ready == 'true'
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ env.VPS_HOST }}
          username: ${{ env.VPS_USER }}
          key: ${{ env.VPS_SSH_KEY }}
          script_stop: true
          script: |
            set -euo pipefail
            TARGET="${{ github.event.inputs.target }}"
            if [ -z "${TARGET}" ]; then TARGET="all"; fi

            cd "${{ env.VPS_DEPLOY_PATH }}"
            git fetch --all
            git checkout main
            git pull --ff-only
            chmod +x ops/deploy/preflight_vps.sh
            /bin/bash ops/deploy/preflight_vps.sh ops/deploy/.env.cyn.vps ops/deploy/.env.operator-console.vps

            if [ "${TARGET}" = "all" ] || [ "${TARGET}" = "cyn" ]; then
              docker compose --env-file ops/deploy/.env.cyn.vps -f ops/docker-compose-cyn.yml --profile vps up -d --remove-orphans
            fi

            if [ "${TARGET}" = "all" ] || [ "${TARGET}" = "operator" ]; then
              docker compose --env-file ops/deploy/.env.operator-console.vps -f ops/deploy/operator-console.compose.yml up -d --build --remove-orphans
            fi
      - name: Deploy skipped (missing secrets)
        if: steps.validate_secrets.outputs.ready != 'true'
        run: echo "Deploy skipped because required repository secrets are not configured."
